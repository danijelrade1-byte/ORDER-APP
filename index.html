<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0F1117">
<title>Order Processor</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --bg: #0F1117;
    --bg2: #1A1D27;
    --bg3: #2A2D3A;
    --text: #E2E4E9;
    --text2: #9CA3AF;
    --text3: #6B7280;
    --accent: #F59E0B;
    --red: #EF4444;
    --green: #10B981;
    --blue: #3B82F6;
    --cyan: #06B6D4;
    --purple: #8B5CF6;
    --orange: #F97316;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  .header {
    background: linear-gradient(135deg, var(--bg2) 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--bg3);
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-inner {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo {
    width: 40px; height: 40px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--red));
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .header h1 {
    font-size: 18px; font-weight: 700;
    background: linear-gradient(90deg, var(--accent), var(--red));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header p { font-size: 11px; color: var(--text3); }

  .settings-toggle {
    background: none; border: 1px solid var(--bg3); border-radius: 8px;
    color: var(--text2); font-size: 18px; cursor: pointer;
    width: 38px; height: 38px; display: flex; align-items: center;
    justify-content: center; flex-shrink: 0;
  }
  .settings-toggle.has-key { border-color: var(--green); color: var(--green); }

  .settings-panel {
    background: var(--bg2); border-bottom: 1px solid var(--bg3);
  }
  .settings-inner {
    max-width: 600px; margin: 0 auto; padding: 16px 20px;
  }

  .tabs {
    max-width: 600px; margin: 12px auto 0; padding: 0 16px;
  }
  .tabs-inner {
    display: flex; gap: 4px; background: var(--bg2);
    border-radius: 10px; padding: 4px;
  }
  .tab-btn {
    flex: 1; padding: 10px 12px; border: none; border-radius: 8px;
    cursor: pointer; font-size: 14px; font-weight: 600;
    font-family: inherit; background: transparent; color: var(--text3);
  }
  .tab-btn.active {
    background: var(--bg3); color: var(--accent);
  }

  .content {
    max-width: 600px; margin: 0 auto;
    padding: 16px 16px 100px;
  }

  .section-label {
    font-size: 13px; font-weight: 600; color: var(--text2);
    margin-bottom: 6px; display: block;
  }
  textarea {
    width: 100%; min-height: 180px; padding: 14px;
    border: 1px solid var(--bg3); border-radius: 12px;
    background: var(--bg2); color: var(--text); font-size: 16px;
    font-family: inherit; resize: vertical; outline: none;
    line-height: 1.6; -webkit-appearance: none;
  }
  textarea:focus { border-color: var(--accent); }

  .upload-zone {
    border: 2px dashed var(--bg3); border-radius: 12px;
    padding: 22px 14px; text-align: center; cursor: pointer;
    background: var(--bg2); margin-top: 14px;
  }
  .upload-zone .icon { font-size: 28px; margin-bottom: 4px; }
  .upload-zone .hint { color: var(--text3); font-size: 13px; }

  .file-attached {
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }

  .process-btn {
    width: 100%; padding: 14px 24px; border: none; border-radius: 10px;
    cursor: pointer; font-size: 16px; font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--red));
    color: var(--bg); margin-top: 16px; -webkit-appearance: none;
  }
  .process-btn:disabled {
    background: var(--bg3); color: var(--text3); opacity: 0.5;
  }

  .tips {
    padding: 14px; background: var(--bg2); border-radius: 12px;
    border: 1px solid var(--bg3); font-size: 13px;
    color: var(--text3); line-height: 1.7; margin-top: 14px;
  }

  .error-msg {
    padding: 12px 14px; background: #2D1215;
    border: 1px solid var(--red); border-radius: 10px;
    color: #FCA5A5; font-size: 13px; margin-top: 14px;
  }

  .empty-state {
    text-align: center; padding: 50px 20px; color: var(--text3);
  }
  .empty-state .big-icon { font-size: 48px; margin-bottom: 10px; }

  .order-card {
    background: var(--bg2); border-radius: 14px;
    border: 1px solid var(--bg3); overflow: hidden;
    margin-bottom: 12px;
  }
  .order-card.expanded { border-color: rgba(245,158,11,0.2); }

  .order-header {
    padding: 14px 16px; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
  }
  .order-title { font-size: 14px; font-weight: 600; color: var(--text); }
  .order-meta { font-size: 12px; color: var(--text3); margin-top: 2px; }

  .order-body { padding: 0 16px 16px; }

  .cat-badges {
    display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap;
  }
  .cat-badge {
    padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
  }

  .cat-section { margin-bottom: 16px; }
  .cat-label {
    font-size: 13px; font-weight: 700;
    margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
  }
  .items-list {
    background: var(--bg); border-radius: 10px;
    border: 1px solid var(--bg3); overflow: hidden;
  }
  .item-row {
    padding: 10px 14px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--bg2);
  }
  .item-row:last-child { border-bottom: none; }
  .item-name { font-size: 14px; color: var(--text); flex: 1; }
  .item-qty {
    font-weight: 700; font-size: 14px; white-space: nowrap;
  }
  .item-note {
    font-size: 11px; color: var(--text2); background: var(--bg3);
    padding: 2px 6px; border-radius: 4px; margin-right: 8px;
  }

  .order-actions {
    display: flex; gap: 8px; margin-top: 10px;
  }
  .action-btn {
    flex: 1; padding: 10px 14px; border: 1px solid var(--bg3);
    border-radius: 8px; background: var(--bg); color: var(--text2);
    cursor: pointer; font-size: 13px; font-weight: 600;
    font-family: inherit; -webkit-appearance: none;
  }
  .action-btn.delete { color: var(--red); flex: 0; }

  .toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--green); color: #fff; padding: 10px 20px;
    border-radius: 10px; font-size: 14px; font-weight: 600;
    z-index: 999; opacity: 0; transition: opacity 0.3s;
  }
  .toast.show { opacity: 1; }

  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="logo">&#x1F4CB;</div>
    <div style="flex:1">
      <h1>Order Processor</h1>
      <p>Paste or photograph any order - structured &amp; categorized</p>
    </div>
    <button class="settings-toggle" id="settings-toggle" onclick="toggleSettings()">&#x2699;&#xFE0F;</button>
  </div>
</div>

<div class="settings-panel hidden" id="settings-panel">
  <div class="settings-inner">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 style="font-size:16px;font-weight:700;color:var(--accent);">Settings</h2>
      <button onclick="toggleSettings()" style="background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;">X</button>
    </div>
    <label class="section-label">Anthropic API Key</label>
    <input type="password" id="api-key-input" placeholder="sk-ant-api03-..."
      style="width:100%;padding:10px 14px;border:1px solid var(--bg3);border-radius:8px;background:var(--bg);color:var(--text);font-size:16px;font-family:inherit;outline:none;-webkit-appearance:none;" />
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button onclick="saveApiKey()" style="flex:1;padding:10px;border:none;border-radius:8px;background:var(--accent);color:var(--bg);font-weight:700;font-family:inherit;cursor:pointer;font-size:14px;-webkit-appearance:none;">Save Key</button>
      <button onclick="toggleKeyVis()" style="padding:10px 14px;border:1px solid var(--bg3);border-radius:8px;background:var(--bg);color:var(--text2);cursor:pointer;font-size:14px;-webkit-appearance:none;">Show/Hide</button>
    </div>
    <div id="key-status" style="margin-top:8px;font-size:12px;color:var(--text3);"></div>
    <div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--bg3);">
      <p style="font-size:12px;color:var(--text3);line-height:1.6;">
        Your API key is stored locally on your device only. Get your key from
        <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent);">console.anthropic.com</a>
      </p>
    </div>
  </div>
</div>

<div class="tabs">
  <div class="tabs-inner">
    <button class="tab-btn active" id="tab-input" onclick="switchTab('input')">New Order</button>
    <button class="tab-btn" id="tab-orders" onclick="switchTab('orders')">Orders (<span id="order-count">0</span>)</button>
  </div>
</div>

<div class="content">
  <div id="view-input">
    <label class="section-label" style="margin-top:8px;">Paste order text (email, WhatsApp, SMS, etc.)</label>
    <textarea id="input-text" placeholder="e.g. Hi, please send us: 20 boxes Heineken, 10 bottles Coca Cola 1.5L, 5 crates mineral water, 3 boxes dish soap..."></textarea>

    <label class="section-label" style="margin-top:14px;">Or upload a photo / screenshot</label>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div id="upload-content">
        <div class="icon">&#x1F4F8;</div>
        <div class="hint">Tap to upload photo, screenshot, or handwritten note</div>
      </div>
    </div>
    <input type="file" id="file-input" accept="image/*" capture="environment" style="display:none" onchange="handleFile(event)">

    <div id="error-box" class="error-msg hidden"></div>

    <button class="process-btn" id="process-btn" onclick="processOrder()" disabled>
      Process Order
    </button>

    <div class="tips">
      <strong>Tips:</strong> Paste any format - messy emails, WhatsApp forwards, SMS, or upload photos of handwritten orders. The AI will extract items and sort them into categories automatically.
    </div>
  </div>

  <div id="view-orders" class="hidden">
    <div id="orders-list"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
var CATEGORIES = [
  { key: "beers", label: "Beers", icon: "\uD83C\uDF7A", color: "#F59E0B" },
  { key: "alcohol", label: "Alcohol Drinks", icon: "\uD83E\uDD43", color: "#EF4444" },
  { key: "soft_drinks", label: "Soft Drinks", icon: "\uD83E\uDD64", color: "#3B82F6" },
  { key: "water", label: "Water", icon: "\uD83D\uDCA7", color: "#06B6D4" },
  { key: "other_beverages", label: "Other Beverages", icon: "\uD83E\uDDC3", color: "#8B5CF6" },
  { key: "food", label: "Food", icon: "\uD83C\uDF7D\uFE0F", color: "#10B981" },
  { key: "chemicals", label: "Chemicals", icon: "\uD83E\uDDF4", color: "#F97316" },
  { key: "other", label: "Other", icon: "\uD83D\uDCE6", color: "#6B7280" }
];

var SYSTEM_PROMPT = "You are an order processing assistant. Your job is to extract order items from messy, unstructured text that may come from emails, WhatsApp messages, Viber, SMS, handwritten notes, or photos.\n\nExtract each item with:\n- name: the product name (clean it up, fix typos if obvious)\n- quantity: number ordered (default to 1 if not specified)\n- unit: unit of measurement (boxes, bottles, crates, pcs, kg, liters, etc.)\n- category: one of exactly these: beers, alcohol, soft_drinks, water, other_beverages, food, chemicals, other\n- notes: any special instructions\n\nCategory guidelines:\n- beers: all beer brands and types\n- alcohol: wine, spirits, liquor, cocktails\n- soft_drinks: cola, juice, energy drinks, sodas\n- water: still water, sparkling water, mineral water\n- other_beverages: coffee, tea, milk, other drinks\n- food: all food items, snacks, ingredients\n- chemicals: cleaning products, detergents, sanitizers\n- other: anything else\n\nRespond ONLY with a JSON object (no markdown, no backticks):\n{\"items\":[{\"name\":\"Product Name\",\"quantity\":10,\"unit\":\"boxes\",\"category\":\"beers\",\"notes\":\"\"}],\"raw_summary\":\"Brief summary\"}\n\nIf not an order return: {\"items\":[],\"raw_summary\":\"Could not identify order items.\"}";

var orders = [];
var imageData = null;
var imageName = "";
var expandedOrder = null;

try {
  orders = JSON.parse(localStorage.getItem("orders") || "[]");
} catch(e) {
  orders = [];
}

function saveOrders() {
  try { localStorage.setItem("orders", JSON.stringify(orders)); } catch(e) {}
}

function getApiKey() {
  try { return localStorage.getItem("anthropic_api_key") || ""; } catch(e) { return ""; }
}

function saveApiKey() {
  var key = document.getElementById("api-key-input").value.trim();
  try {
    if (!key) {
      localStorage.removeItem("anthropic_api_key");
      document.getElementById("key-status").innerHTML = "<span style='color:#EF4444'>Key removed.</span>";
    } else {
      localStorage.setItem("anthropic_api_key", key);
      document.getElementById("key-status").innerHTML = "<span style='color:#10B981'>Key saved on your device.</span>";
    }
  } catch(e) {
    document.getElementById("key-status").innerHTML = "<span style='color:#EF4444'>Error saving key.</span>";
  }
  updateSettingsIcon();
}

function updateSettingsIcon() {
  var btn = document.getElementById("settings-toggle");
  if (getApiKey()) {
    btn.classList.add("has-key");
  } else {
    btn.classList.remove("has-key");
  }
}

function toggleSettings() {
  var panel = document.getElementById("settings-panel");
  if (panel.classList.contains("hidden")) {
    panel.classList.remove("hidden");
    document.getElementById("api-key-input").value = getApiKey();
    document.getElementById("key-status").textContent = getApiKey() ? "Key is set" : "No key saved yet.";
  } else {
    panel.classList.add("hidden");
  }
}

function toggleKeyVis() {
  var input = document.getElementById("api-key-input");
  input.type = input.type === "password" ? "text" : "password";
}

function switchTab(tab) {
  document.getElementById("tab-input").className = "tab-btn" + (tab === "input" ? " active" : "");
  document.getElementById("tab-orders").className = "tab-btn" + (tab === "orders" ? " active" : "");
  if (tab === "input") {
    document.getElementById("view-input").classList.remove("hidden");
    document.getElementById("view-orders").classList.add("hidden");
  } else {
    document.getElementById("view-input").classList.add("hidden");
    document.getElementById("view-orders").classList.remove("hidden");
    renderOrders();
  }
}

function handleFile(e) {
  var file = e.target.files[0];
  if (!file) return;
  imageName = file.name;
  var reader = new FileReader();
  reader.onload = function() {
    var base64 = reader.result.split(",")[1];
    imageData = { base64: base64, mediaType: file.type || "image/jpeg" };
    document.getElementById("upload-content").innerHTML =
      "<div class='file-attached'>" +
      "<span style='color:#10B981;font-size:18px'>&#x2713;</span> " +
      "<span style='color:var(--text);font-size:14px'>" + escHtml(imageName) + "</span> " +
      "<button onclick='event.stopPropagation();removeImage()' style='background:#EF4444;border:none;color:#fff;border-radius:6px;padding:2px 8px;cursor:pointer;font-size:12px'>X</button>" +
      "</div>";
    updateProcessBtn();
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  imageData = null;
  imageName = "";
  document.getElementById("file-input").value = "";
  document.getElementById("upload-content").innerHTML =
    "<div class='icon'>&#x1F4F8;</div>" +
    "<div class='hint'>Tap to upload photo, screenshot, or handwritten note</div>";
  updateProcessBtn();
}

function updateProcessBtn() {
  var text = document.getElementById("input-text").value.trim();
  document.getElementById("process-btn").disabled = (!text && !imageData);
}

document.getElementById("input-text").addEventListener("input", updateProcessBtn);

function processOrder() {
  var text = document.getElementById("input-text").value.trim();
  if (!text && !imageData) return;

  var btn = document.getElementById("process-btn");
  btn.disabled = true;
  btn.textContent = "Processing...";
  btn.style.background = "var(--bg3)";
  btn.style.color = "var(--text3)";
  document.getElementById("error-box").classList.add("hidden");

  var apiKey = getApiKey();
  if (!apiKey) {
    showError("Please add your Anthropic API key first. Tap the gear icon in the top right.");
    resetBtn();
    return;
  }

  var userContent = [];
  if (imageData) {
    userContent.push({
      type: "image",
      source: { type: "base64", media_type: imageData.mediaType, data: imageData.base64 }
    });
  }
  var textPart = text
    ? "Extract and categorize all order items from the following:\n\n" + text
    : "Extract and categorize all order items from this image.";
  userContent.push({ type: "text", text: textPart });

  fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": apiKey,
      "anthropic-version": "2023-06-01",
      "anthropic-dangerous-direct-browser-access": "true"
    },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      system: SYSTEM_PROMPT,
      messages: [{ role: "user", content: userContent }]
    })
  })
  .then(function(response) { return response.json(); })
  .then(function(data) {
    if (data.error) throw new Error(data.error.message || "API error");
    var respText = "";
    if (data.content) {
      for (var i = 0; i < data.content.length; i++) {
        if (data.content[i].type === "text") respText += data.content[i].text;
      }
    }
    respText = respText.trim();
    if (!respText) throw new Error("No response from AI");

    var cleaned = respText.replace(/```json/g, "").replace(/```/g, "").trim();
    var parsed = JSON.parse(cleaned);

    var newOrder = {
      id: Date.now(),
      timestamp: new Date().toLocaleString(),
      source: imageData ? "Photo: " + imageName : "Text input",
      summary: parsed.raw_summary,
      items: parsed.items || [],
      inputPreview: text.substring(0, 120) || "(image)"
    };

    orders.unshift(newOrder);
    saveOrders();
    document.getElementById("order-count").textContent = orders.length;
    document.getElementById("input-text").value = "";
    removeImage();
    expandedOrder = newOrder.id;
    switchTab("orders");
    showToast("Order processed!");
    resetBtn();
  })
  .catch(function(err) {
    showError("Failed to process: " + err.message);
    resetBtn();
  });
}

function resetBtn() {
  var btn = document.getElementById("process-btn");
  btn.textContent = "Process Order";
  btn.style.background = "";
  btn.style.color = "";
  updateProcessBtn();
}

function showError(msg) {
  var box = document.getElementById("error-box");
  box.textContent = msg;
  box.classList.remove("hidden");
}

function renderOrders() {
  document.getElementById("order-count").textContent = orders.length;
  var container = document.getElementById("orders-list");

  if (orders.length === 0) {
    container.innerHTML =
      "<div class='empty-state'>" +
      "<div class='big-icon'>&#x1F4ED;</div>" +
      "<p>No orders processed yet.</p>" +
      "<button onclick=\"switchTab('input')\" style='margin-top:12px;padding:10px 20px;background:var(--bg3);border:none;border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;font-family:inherit;-webkit-appearance:none;'>Process your first order</button>" +
      "</div>";
    return;
  }

  var html = "";
  for (var i = 0; i < orders.length; i++) {
    var order = orders[i];
    var isExp = expandedOrder === order.id;
    var grouped = getGrouped(order.items);
    html += "<div class='order-card " + (isExp ? "expanded" : "") + "'>";
    html += "<div class='order-header' onclick='toggleOrder(" + order.id + ")'>";
    html += "<div><div class='order-title'>" + escHtml(order.source) + " - " + order.items.length + " items</div>";
    html += "<div class='order-meta'>" + escHtml(order.timestamp) + " | " + escHtml(order.summary) + "</div></div>";
    html += "<span style='font-size:12px;color:var(--text3)'>" + (isExp ? "&#x25B2;" : "&#x25BC;") + "</span>";
    html += "</div>";
    if (isExp) {
      html += renderOrderBody(order, grouped);
    }
    html += "</div>";
  }
  container.innerHTML = html;
}

function renderOrderBody(order, grouped) {
  var html = "<div class='order-body'><div class='cat-badges'>";
  for (var i = 0; i < grouped.length; i++) {
    var g = grouped[i];
    html += "<span class='cat-badge' style='background:" + g.color + "22;color:" + g.color + "'>" + g.icon + " " + g.items.length + "</span>";
  }
  html += "</div>";

  for (var i = 0; i < grouped.length; i++) {
    var g = grouped[i];
    html += "<div class='cat-section'>";
    html += "<div class='cat-label' style='color:" + g.color + "'>" + g.icon + " " + g.label + "</div>";
    html += "<div class='items-list'>";
    for (var j = 0; j < g.items.length; j++) {
      var item = g.items[j];
      html += "<div class='item-row'>";
      html += "<span class='item-name'>" + escHtml(item.name) + "</span>";
      html += "<div style='display:flex;align-items:center;gap:8px'>";
      if (item.notes) html += "<span class='item-note'>" + escHtml(item.notes) + "</span>";
      html += "<span class='item-qty' style='color:" + g.color + "'>" + item.quantity + " " + escHtml(item.unit || "") + "</span>";
      html += "</div></div>";
    }
    html += "</div></div>";
  }

  html += "<div class='order-actions'>";
  html += "<button class='action-btn' onclick='exportOrder(" + order.id + ")'>Copy to Clipboard</button>";
  html += "<button class='action-btn delete' onclick='deleteOrder(" + order.id + ")'>Delete</button>";
  html += "</div></div>";
  return html;
}

function getGrouped(items) {
  var map = {};
  for (var i = 0; i < CATEGORIES.length; i++) map[CATEGORIES[i].key] = [];
  for (var i = 0; i < items.length; i++) {
    var cat = map[items[i].category] ? items[i].category : "other";
    map[cat].push(items[i]);
  }
  var result = [];
  for (var i = 0; i < CATEGORIES.length; i++) {
    if (map[CATEGORIES[i].key].length > 0) {
      result.push({ key: CATEGORIES[i].key, label: CATEGORIES[i].label, icon: CATEGORIES[i].icon, color: CATEGORIES[i].color, items: map[CATEGORIES[i].key] });
    }
  }
  return result;
}

function toggleOrder(id) {
  expandedOrder = expandedOrder === id ? null : id;
  renderOrders();
}

function deleteOrder(id) {
  var newOrders = [];
  for (var i = 0; i < orders.length; i++) {
    if (orders[i].id !== id) newOrders.push(orders[i]);
  }
  orders = newOrders;
  saveOrders();
  renderOrders();
  showToast("Order deleted");
}

function exportOrder(id) {
  var order = null;
  for (var i = 0; i < orders.length; i++) {
    if (orders[i].id === id) { order = orders[i]; break; }
  }
  if (!order) return;
  var grouped = getGrouped(order.items);
  var text = "ORDER - " + order.timestamp + "\nSource: " + order.source + "\n----------------------------------------\n\n";
  for (var i = 0; i < grouped.length; i++) {
    var g = grouped[i];
    text += g.icon + " " + g.label.toUpperCase() + "\n";
    for (var j = 0; j < g.items.length; j++) {
      var item = g.items[j];
      text += "  - " + item.quantity + " " + (item.unit || "") + " - " + item.name;
      if (item.notes) text += " (" + item.notes + ")";
      text += "\n";
    }
    text += "\n";
  }
  text += "----------------------------------------\nTotal items: " + order.items.length;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(function() { showToast("Copied to clipboard!"); });
  } else {
    var ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try { document.execCommand("copy"); showToast("Copied to clipboard!"); } catch(e) {}
    document.body.removeChild(ta);
  }
}

function showToast(msg) {
  var t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(function() { t.classList.remove("show"); }, 2000);
}

function escHtml(s) {
  if (!s) return "";
  var div = document.createElement("div");
  div.appendChild(document.createTextNode(s));
  return div.innerHTML;
}

// Init
document.getElementById("order-count").textContent = orders.length;
updateSettingsIcon();
</script>
</body>
</html>
