<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0F1117">
<title>Order Processor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0a2e1a;
  --bg2: #1A1D27;
  --bg3: #2A2D3A;
  --text: #E2E4E9;
  --text2: #9CA3AF;
  --text3: #6B7280;
  --accent: #F59E0B;
  --red: #EF4444;
  --green: #10B981;
  --blue: #3B82F6;
  --cyan: #06B6D4;
  --purple: #8B5CF6;
  --orange: #F97316;
  --whatsapp: #25D366;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; -webkit-font-smoothing: antialiased; overflow-x: hidden;
}

.header {
  background: linear-gradient(135deg, var(--bg2) 0%, var(--bg) 100%);
  border-bottom: 1px solid var(--bg3);
  padding: 14px 16px; position: sticky; top: 0; z-index: 100;
}
.header-inner {
  max-width: 640px; margin: 0 auto;
  display: flex; align-items: center; gap: 10px;
}
.logo {
  width: 42px; height: 42px; border-radius: 12px;
  background: linear-gradient(135deg, var(--accent), var(--red));
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
}
.header h1 {
  font-size: 18px; font-weight: 700;
  background: linear-gradient(90deg, var(--accent), var(--red));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.header p { font-size: 11px; color: var(--text3); }
.header-btns { display: flex; gap: 6px; flex-shrink: 0; }

.icon-btn {
  background: none; border: 1px solid var(--bg3); border-radius: 10px;
  color: var(--text2); font-size: 18px; cursor: pointer;
  width: 40px; height: 40px; display: flex; align-items: center;
  justify-content: center; flex-shrink: 0; -webkit-appearance: none;
}
.icon-btn.has-key { border-color: var(--green); color: var(--green); }

.panel {
  background: var(--bg2); border-bottom: 1px solid var(--bg3);
  max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
}
.panel.open { max-height: 900px; overflow-y: auto; }
.panel-inner { max-width: 640px; margin: 0 auto; padding: 16px; }
.panel-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;
}
.panel-header h2 { font-size: 16px; font-weight: 700; color: var(--accent); }
.close-btn {
  background: none; border: none; color: var(--text3); font-size: 22px;
  cursor: pointer; width: 36px; height: 36px; display: flex;
  align-items: center; justify-content: center;
}

.tabs { max-width: 640px; margin: 10px auto 0; padding: 0 16px; }
.tabs-inner {
  display: flex; gap: 4px; background: var(--bg2); border-radius: 12px; padding: 4px;
}
.tab-btn {
  flex: 1; padding: 12px 10px; border: none; border-radius: 10px;
  cursor: pointer; font-size: 15px; font-weight: 600;
  font-family: inherit; background: transparent; color: var(--text3); -webkit-appearance: none;
}
.tab-btn.active { background: var(--bg3); color: var(--accent); }

.content { max-width: 640px; margin: 0 auto; padding: 14px 16px 120px; }

.label { font-size: 13px; font-weight: 600; color: var(--text2); margin-bottom: 6px; display: block; }

.input-field {
  width: 100%; padding: 14px; border: 1px solid var(--bg3); border-radius: 12px;
  background: var(--bg2); color: var(--text); font-size: 16px;
  font-family: inherit; outline: none; -webkit-appearance: none;
}
.input-field:focus { border-color: var(--accent); }
textarea.input-field { min-height: 160px; resize: vertical; line-height: 1.6; }

.upload-zone {
  border: 2px dashed var(--bg3); border-radius: 14px;
  padding: 24px 14px; text-align: center; cursor: pointer;
  background: var(--bg2); margin-top: 10px;
}

.btn-primary {
  width: 100%; padding: 16px 24px; border: none; border-radius: 14px;
  cursor: pointer; font-size: 18px; font-weight: 700;
  background: linear-gradient(135deg, var(--accent), var(--red));
  color: var(--bg); margin-top: 16px; -webkit-appearance: none; min-height: 56px;
}
.btn-primary:disabled { background: var(--bg3); color: var(--text3); opacity: 0.5; }

.btn-secondary {
  padding: 14px 18px; border: 1px solid var(--bg3); border-radius: 12px;
  background: var(--bg); color: var(--text2); cursor: pointer;
  font-size: 14px; font-weight: 600; font-family: inherit;
  -webkit-appearance: none; min-height: 48px;
}

.btn-whatsapp {
  padding: 14px 18px; border: none; border-radius: 12px;
  background: var(--whatsapp); color: #fff; cursor: pointer;
  font-size: 14px; font-weight: 600; font-family: inherit;
  -webkit-appearance: none; min-height: 48px;
}

.btn-danger {
  padding: 14px 18px; border: 1px solid var(--red); border-radius: 12px;
  background: transparent; color: var(--red); cursor: pointer;
  font-size: 14px; font-weight: 600; font-family: inherit;
  -webkit-appearance: none; min-height: 48px;
}

.search-bar { display: flex; gap: 8px; margin-bottom: 14px; }
.search-input {
  flex: 1; padding: 12px 14px; border: 1px solid var(--bg3); border-radius: 12px;
  background: var(--bg2); color: var(--text); font-size: 15px;
  font-family: inherit; outline: none; -webkit-appearance: none;
}
.search-input:focus { border-color: var(--accent); }

.order-card {
  background: var(--bg2); border-radius: 16px;
  border: 1px solid var(--bg3); overflow: hidden; margin-bottom: 12px;
}
.order-card.expanded { border-color: rgba(245,158,11,0.25); }
.order-header {
  padding: 16px; cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
}
.order-title { font-size: 15px; font-weight: 600; color: var(--text); }
.order-customer { font-size: 13px; color: var(--accent); margin-top: 2px; }
.order-meta { font-size: 12px; color: var(--text3); margin-top: 3px; }

.order-body { padding: 0 16px 16px; }
.cat-badges { display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap; }
.cat-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }

.cat-section { margin-bottom: 16px; }
.cat-label { font-size: 14px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.items-list { background: var(--bg); border-radius: 12px; border: 1px solid var(--bg3); overflow: hidden; }
.item-row {
  padding: 12px 14px; display: flex; justify-content: space-between;
  align-items: center; border-bottom: 1px solid var(--bg2);
}
.item-row:last-child { border-bottom: none; }
.item-name { font-size: 15px; color: var(--text); flex: 1; }
.item-qty { font-weight: 700; font-size: 15px; white-space: nowrap; }
.item-note { font-size: 11px; color: var(--text2); background: var(--bg3); padding: 3px 8px; border-radius: 6px; margin-right: 8px; }

.order-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
.order-actions > * { flex: 1; text-align: center; min-width: 0; }

.cat-edit-row {
  display: flex; gap: 8px; align-items: center;
  padding: 10px 0; border-bottom: 1px solid var(--bg3);
}
.cat-edit-row input {
  flex: 1; padding: 10px; border: 1px solid var(--bg3); border-radius: 8px;
  background: var(--bg); color: var(--text); font-size: 14px;
  font-family: inherit; outline: none; -webkit-appearance: none;
}

.empty-state { text-align: center; padding: 50px 20px; color: var(--text3); }
.empty-state .big-icon { font-size: 52px; margin-bottom: 10px; }

.tips {
  padding: 14px; background: var(--bg2); border-radius: 14px;
  border: 1px solid var(--bg3); font-size: 13px; color: var(--text3);
  line-height: 1.7; margin-top: 14px;
}

.error-msg {
  padding: 14px; background: #2D1215; border: 1px solid var(--red);
  border-radius: 12px; color: #FCA5A5; font-size: 13px; margin-top: 14px;
}

.toast {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
  background: var(--green); color: #fff; padding: 12px 24px;
  border-radius: 12px; font-size: 15px; font-weight: 600;
  z-index: 999; opacity: 0; transition: opacity 0.3s; max-width: 90%;
}
.toast.show { opacity: 1; }

.lang-row { display: flex; gap: 4px; background: var(--bg); border-radius: 8px; padding: 3px; }
.lang-btn {
  padding: 8px 14px; border: none; border-radius: 6px;
  font-size: 13px; font-weight: 600; cursor: pointer;
  font-family: inherit; -webkit-appearance: none;
  background: transparent; color: var(--text3);
}
.lang-btn.active { background: var(--bg3); color: var(--accent); }

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="logo">&#x1F4CB;</div>
    <div style="flex:1">
      <h1>Order Processor</h1>
      <p id="header-subtitle"></p>
    </div>
    <div class="header-btns">
      <button class="icon-btn" id="btn-categories" onclick="togglePanel('categories')">&#x1F4DD;</button>
      <button class="icon-btn" id="btn-settings" onclick="togglePanel('settings')">&#x2699;&#xFE0F;</button>
    </div>
  </div>
</div>

<div class="panel" id="panel-settings">
  <div class="panel-inner">
    <div class="panel-header">
      <h2 id="lbl-settings"></h2>
      <button class="close-btn" onclick="togglePanel('settings')">&#x2715;</button>
    </div>
    <label class="label" id="lbl-language"></label>
    <div class="lang-row" style="margin-bottom:14px;">
      <button class="lang-btn" id="lang-hr" onclick="setLang('hr')">&#x1F1ED;&#x1F1F7; Hrvatski</button>
      <button class="lang-btn" id="lang-en" onclick="setLang('en')">&#x1F1EC;&#x1F1E7; English</button>
    </div>
    <label class="label" id="lbl-apikey"></label>
    <input type="text" id="api-key-input" class="input-field" style="margin-bottom:8px;" />
    <div style="display:flex;gap:8px;">
      <button onclick="saveApiKey()" id="btn-save-key" style="flex:1;padding:12px;border:none;border-radius:10px;background:var(--accent);color:var(--bg);font-weight:700;font-family:inherit;cursor:pointer;font-size:15px;-webkit-appearance:none;min-height:48px;"></button>
      <button onclick="toggleKeyVis()" class="btn-secondary" id="btn-show-key"></button>
    </div>
    <div id="key-status" style="margin-top:8px;font-size:12px;color:var(--text3);"></div>
    <div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--bg3);">
      <p style="font-size:12px;color:var(--text3);line-height:1.6;" id="lbl-key-info"></p>
    </div>
  </div>
</div>

<div class="panel" id="panel-categories">
  <div class="panel-inner">
    <div class="panel-header">
      <h2 id="lbl-categories-title"></h2>
      <button class="close-btn" onclick="togglePanel('categories')">&#x2715;</button>
    </div>
    <div id="categories-editor"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button onclick="addCategory()" class="btn-secondary" style="flex:1;" id="btn-add-cat"></button>
      <button onclick="saveCategories()" id="btn-save-cats" style="flex:1;padding:12px;border:none;border-radius:10px;background:var(--accent);color:var(--bg);font-weight:700;font-family:inherit;cursor:pointer;font-size:14px;-webkit-appearance:none;min-height:48px;"></button>
    </div>
    <button onclick="resetCategories()" class="btn-danger" style="width:100%;margin-top:8px;" id="btn-reset-cats"></button>
  </div>
</div>

<div class="tabs">
  <div class="tabs-inner">
    <button class="tab-btn active" id="tab-input" onclick="switchTab('input')"><span id="lbl-tab-new"></span></button>
    <button class="tab-btn" id="tab-orders" onclick="switchTab('orders')"><span id="lbl-tab-orders"></span> (<span id="order-count">0</span>)</button>
  </div>
</div>

<div class="content">
  <div id="view-input">
    <label class="label" style="margin-top:6px;" id="lbl-customer"></label>
    <input type="text" id="customer-name" class="input-field" style="margin-bottom:14px;" />

    <label class="label" id="lbl-paste"></label>
    <textarea id="input-text" class="input-field"></textarea>

    <label class="label" style="margin-top:14px;" id="lbl-upload"></label>
    <div class="upload-zone" onclick="document.getElementById('file-input').click()">
      <div id="upload-content">
        <div style="font-size:32px;margin-bottom:6px;">&#x1F4F8;</div>
        <div style="color:var(--text3);font-size:13px;" id="lbl-upload-hint"></div>
      </div>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(event)">

    <div id="error-box" class="error-msg hidden"></div>

    <button class="btn-primary" id="process-btn" onclick="processOrder()" disabled>
      <span id="lbl-process"></span>
    </button>

    <div class="tips" id="tips-box"></div>
  </div>

  <div id="view-orders" class="hidden">
    <div class="search-bar">
      <input type="text" class="search-input" id="search-input" oninput="renderOrders()" />
      <button class="btn-secondary" onclick="exportAllCSV()" id="btn-export-all" style="white-space:nowrap;"></button>
    </div>
    <div id="orders-list"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
var DEFAULT_CATEGORIES = [
  { key: "beers", label: "Piva", labelEn: "Beers", icon: "\uD83C\uDF7A", color: "#F59E0B" },
  { key: "alcohol", label: "Alkoholna pi\u0107a", labelEn: "Alcohol Drinks", icon: "\uD83E\uDD43", color: "#EF4444" },
  { key: "soft_drinks", label: "Bezalkoholna pi\u0107a", labelEn: "Soft Drinks", icon: "\uD83E\uDD64", color: "#3B82F6" },
  { key: "water", label: "Voda", labelEn: "Water", icon: "\uD83D\uDCA7", color: "#06B6D4" },
  { key: "other_beverages", label: "Ostala pi\u0107a", labelEn: "Other Beverages", icon: "\uD83E\uDDC3", color: "#8B5CF6" },
  { key: "food", label: "Hrana", labelEn: "Food", icon: "\uD83C\uDF7D\uFE0F", color: "#10B981" },
  { key: "chemicals", label: "Kemija", labelEn: "Chemicals", icon: "\uD83E\uDDF4", color: "#F97316" },
  { key: "other", label: "Ostalo", labelEn: "Other", icon: "\uD83D\uDCE6", color: "#6B7280" }
];

var STRINGS = {
  hr: {
    subtitle: "Narudžbe brzo i jednostavno",
    settings: "Postavke", language: "Jezik / Language",
    apikey: "Anthropic API Key", save: "Spremi", showHide: "Prikaži/Sakrij",
    keyInfo: 'Ključ se čuva samo na vašem uređaju. <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent);">Dobijte ključ ovdje</a>',
    categoriesTitle: "Kategorije", addCat: "+ Dodaj", resetCats: "Vrati zadano",
    tabNew: "Nova narudžba", tabOrders: "Narudžbe",
    customer: "Kupac / Naziv", paste: "Zalijepi tekst narudžbe (email, WhatsApp, SMS...)",
    upload: "Ili učitaj fotografiju", uploadHint: "Dotakni za fotografiju ili snimku zaslona",
    process: "Obradi narudžbu", processing: "Obrada u tijeku...",
    placeholder: "npr. Pošaljite nam: 20 kutija Heineken, 10 boca Coca Cola, 5 gajbi vode...",
    tips: "<strong>Savjet:</strong> Zalijepi bilo koji format — email, WhatsApp, SMS, ili učitaj fotografiju. AI će automatski izvući artikle i razvrstati ih.",
    search: "Pretraži narudžbe...", exportAll: "CSV",
    copy: "Kopiraj", whatsapp: "WhatsApp", excel: "CSV", delete: "Obriši",
    word: "Word", pdf: "PDF",
    noOrders: "Nema narudžbi.", firstOrder: "Obradi prvu narudžbu",
    keySaved: "Ključ spremljen.", keyRemoved: "Ključ uklonjen.",
    noKey: "Dodajte API ključ u Postavkama (ikona zupčanika).",
    orderProcessed: "Narudžba obrađena!", orderDeleted: "Narudžba obrisana.",
    copied: "Kopirano!", catsSaved: "Kategorije spremljene!", catsReset: "Kategorije vraćene.",
    items: "artikala", textInput: "Tekst", photo: "Foto", total: "Ukupno artikala"
  },
  en: {
    subtitle: "Orders quick and easy",
    settings: "Settings", language: "Language",
    apikey: "Anthropic API Key", save: "Save", showHide: "Show/Hide",
    keyInfo: 'Key stored on your device only. <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent);">Get your key here</a>',
    categoriesTitle: "Categories", addCat: "+ Add", resetCats: "Reset to default",
    tabNew: "New Order", tabOrders: "Orders",
    customer: "Customer / Name", paste: "Paste order text (email, WhatsApp, SMS...)",
    upload: "Or upload a photo", uploadHint: "Tap to upload photo or screenshot",
    process: "Process Order", processing: "Processing...",
    placeholder: "e.g. Please send: 20 boxes Heineken, 10 bottles Coca Cola, 5 crates water...",
    tips: "<strong>Tip:</strong> Paste any format — emails, WhatsApp, SMS, or upload photos. AI extracts items and sorts them automatically.",
    search: "Search orders...", exportAll: "CSV",
    copy: "Copy", whatsapp: "WhatsApp", excel: "CSV", delete: "Delete",
    word: "Word", pdf: "PDF",
    noOrders: "No orders yet.", firstOrder: "Process your first order",
    keySaved: "Key saved.", keyRemoved: "Key removed.",
    noKey: "Please add your API key in Settings (gear icon).",
    orderProcessed: "Order processed!", orderDeleted: "Order deleted.",
    copied: "Copied!", catsSaved: "Categories saved!", catsReset: "Categories reset.",
    items: "items", textInput: "Text", photo: "Photo", total: "Total items"
  }
};

var lang = "hr";
var orders = [];
var categories = [];
var imageData = null;
var imageName = "";
var expandedOrder = null;
var openPanel = null;

try { lang = localStorage.getItem("app_lang") || "hr"; } catch(e) {}
try { orders = JSON.parse(localStorage.getItem("orders") || "[]"); } catch(e) { orders = []; }
try {
  var sc = localStorage.getItem("categories");
  categories = sc ? JSON.parse(sc) : JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
} catch(e) { categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)); }

function S(k) { return (STRINGS[lang] && STRINGS[lang][k]) || STRINGS.en[k] || k; }
function catLabel(c) { return lang === "en" ? (c.labelEn || c.label) : c.label; }
function sv(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }

function setLang(l) {
  lang = l;
  try { localStorage.setItem("app_lang", l); } catch(e) {}
  document.getElementById("lang-hr").className = "lang-btn" + (l === "hr" ? " active" : "");
  document.getElementById("lang-en").className = "lang-btn" + (l === "en" ? " active" : "");
  updateUI();
}

function updateUI() {
  var ids = {
    "header-subtitle": "subtitle", "lbl-settings": "settings", "lbl-language": "language",
    "lbl-apikey": "apikey", "btn-save-key": "save", "btn-show-key": "showHide",
    "lbl-categories-title": "categoriesTitle", "btn-add-cat": "addCat",
    "btn-save-cats": "save", "btn-reset-cats": "resetCats",
    "lbl-tab-new": "tabNew", "lbl-tab-orders": "tabOrders",
    "lbl-customer": "customer", "lbl-paste": "paste",
    "lbl-upload": "upload", "lbl-upload-hint": "uploadHint",
    "lbl-process": "process", "btn-export-all": "exportAll"
  };
  for (var id in ids) {
    var el = document.getElementById(id);
    if (el) el.textContent = S(ids[id]);
  }
  document.getElementById("lbl-key-info").innerHTML = S("keyInfo");
  document.getElementById("tips-box").innerHTML = S("tips");
  document.getElementById("search-input").placeholder = S("search");
  document.getElementById("input-text").placeholder = S("placeholder");
  renderCategoriesEditor();
  renderOrders();
}

function togglePanel(name) {
  var panel = document.getElementById("panel-" + name);
  if (openPanel === name) {
    panel.classList.remove("open"); openPanel = null;
  } else {
    if (openPanel) document.getElementById("panel-" + openPanel).classList.remove("open");
    panel.classList.add("open"); openPanel = name;
    if (name === "settings") {
      document.getElementById("api-key-input").value = getApiKey();
      document.getElementById("key-status").textContent = getApiKey() ? S("keySaved") : "";
    }
    if (name === "categories") renderCategoriesEditor();
  }
}

function getApiKey() { try { return localStorage.getItem("anthropic_api_key") || ""; } catch(e) { return ""; } }

function saveApiKey() {
  var key = document.getElementById("api-key-input").value.trim();
  try {
    if (!key) { localStorage.removeItem("anthropic_api_key"); document.getElementById("key-status").innerHTML = "<span style='color:var(--red)'>" + S("keyRemoved") + "</span>"; }
    else { localStorage.setItem("anthropic_api_key", key); document.getElementById("key-status").innerHTML = "<span style='color:var(--green)'>" + S("keySaved") + "</span>"; }
  } catch(e) {}
  updateSettingsIcon();
}

function updateSettingsIcon() {
  var btn = document.getElementById("btn-settings");
  if (getApiKey()) btn.classList.add("has-key"); else btn.classList.remove("has-key");
}

function toggleKeyVis() {
  var i = document.getElementById("api-key-input");
  i.type = i.type === "password" ? "text" : "password";
}

function renderCategoriesEditor() {
  var h = "";
  for (var i = 0; i < categories.length; i++) {
    var c = categories[i];
    h += "<div class='cat-edit-row'>" +
      "<input type='color' value='" + c.color + "' style='width:42px;height:42px;border:none;padding:0;cursor:pointer;border-radius:8px;' data-idx='" + i + "' data-field='color' onchange='updateCatField(this)' />" +
      "<input value='" + escAttr(c.icon) + "' style='width:50px;text-align:center;font-size:18px;' data-idx='" + i + "' data-field='icon' oninput='updateCatField(this)' />" +
      "<input value='" + escAttr(catLabel(c)) + "' data-idx='" + i + "' data-field='label' oninput='updateCatField(this)' />" +
      "<button onclick='removeCat(" + i + ")' style='background:none;border:none;color:var(--red);font-size:20px;cursor:pointer;padding:8px;'>&#x2715;</button></div>";
  }
  document.getElementById("categories-editor").innerHTML = h;
}

function updateCatField(el) {
  var idx = parseInt(el.getAttribute("data-idx"));
  var f = el.getAttribute("data-field");
  if (f === "label") { if (lang === "en") categories[idx].labelEn = el.value; else categories[idx].label = el.value; }
  else categories[idx][f] = el.value;
}

function addCategory() {
  categories.push({ key: "custom_" + Date.now(), label: "Nova", labelEn: "New", icon: "\uD83D\uDCE6", color: "#6B7280" });
  renderCategoriesEditor();
}

function removeCat(idx) { categories.splice(idx, 1); renderCategoriesEditor(); }

function saveCategories() {
  for (var i = 0; i < categories.length; i++) {
    if (categories[i].key.indexOf("custom_") === 0) {
      categories[i].key = categories[i].label.toLowerCase().replace(/[^a-z0-9]/g, "_");
    }
  }
  sv("categories", categories); showToast(S("catsSaved"));
}

function resetCategories() {
  categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
  sv("categories", categories); renderCategoriesEditor(); showToast(S("catsReset"));
}

function switchTab(tab) {
  document.getElementById("tab-input").className = "tab-btn" + (tab === "input" ? " active" : "");
  document.getElementById("tab-orders").className = "tab-btn" + (tab === "orders" ? " active" : "");
  document.getElementById("view-input").classList.toggle("hidden", tab !== "input");
  document.getElementById("view-orders").classList.toggle("hidden", tab !== "orders");
  if (tab === "orders") renderOrders();
}

function handleFile(e) {
  var file = e.target.files[0]; if (!file) return;
  imageName = file.name;
  compressImage(file, function(b64, mt) {
    imageData = { base64: b64, mediaType: mt };
    document.getElementById("upload-content").innerHTML =
      "<div style='display:flex;align-items:center;justify-content:center;gap:10px'>" +
      "<span style='color:var(--green);font-size:20px'>&#x2713;</span>" +
      "<span style='color:var(--text);font-size:14px'>" + escHtml(imageName) + "</span>" +
      "<button onclick='event.stopPropagation();removeImage()' style='background:var(--red);border:none;color:#fff;border-radius:8px;padding:6px 12px;cursor:pointer;font-size:13px;'>X</button></div>";
    updateProcessBtn();
  });
}

function compressImage(file, cb) {
  var r = new FileReader();
  r.onload = function() {
    var img = new Image();
    img.onload = function() {
      var mx = 1600, w = img.width, h = img.height;
      if (w > mx || h > mx) { if (w > h) { h = Math.round(h*mx/w); w = mx; } else { w = Math.round(w*mx/h); h = mx; } }
      var c = document.createElement("canvas"); c.width = w; c.height = h;
      c.getContext("2d").drawImage(img, 0, 0, w, h);
      var d = c.toDataURL("image/jpeg", 0.7), b = d.split(",")[1];
      if (b.length > 4500000) { d = c.toDataURL("image/jpeg", 0.4); b = d.split(",")[1]; }
      cb(b, "image/jpeg");
    };
    img.src = r.result;
  };
  r.readAsDataURL(file);
}

function removeImage() {
  imageData = null; imageName = "";
  document.getElementById("file-input").value = "";
  document.getElementById("upload-content").innerHTML =
    "<div style='font-size:32px;margin-bottom:6px;'>&#x1F4F8;</div><div style='color:var(--text3);font-size:13px;'>" + S("uploadHint") + "</div>";
  updateProcessBtn();
}

function updateProcessBtn() {
  document.getElementById("process-btn").disabled = (!document.getElementById("input-text").value.trim() && !imageData);
}
document.getElementById("input-text").addEventListener("input", updateProcessBtn);

function processOrder() {
  var text = document.getElementById("input-text").value.trim();
  if (!text && !imageData) return;
  var btn = document.getElementById("process-btn");
  btn.disabled = true;
  document.getElementById("lbl-process").textContent = S("processing");
  btn.style.background = "var(--bg3)"; btn.style.color = "var(--text3)";
  document.getElementById("error-box").classList.add("hidden");

  var apiKey = getApiKey();
  if (!apiKey) { showError(S("noKey")); resetBtn(); return; }

  var catKeys = [], catList = "";
  for (var i = 0; i < categories.length; i++) {
    catKeys.push('"' + categories[i].key + '"');
    catList += "- " + categories[i].key + ": " + catLabel(categories[i]) + "\n";
  }

  var sys = "You are an order processing assistant. Extract order items from messy text (emails, WhatsApp, Viber, SMS, handwritten notes, photos).\n\nExtract each item:\n- name: product name (fix typos)\n- quantity: number (default 1)\n- unit: boxes, bottles, crates, pcs, kg, liters, etc.\n- category: one of: " + catKeys.join(", ") + "\n- notes: special instructions\n\nCategories:\n" + catList + "\nRespond ONLY JSON (no markdown):\n{\"items\":[{\"name\":\"Product\",\"quantity\":10,\"unit\":\"boxes\",\"category\":\"beers\",\"notes\":\"\"}],\"raw_summary\":\"Brief summary\"}\n\nIf not an order: {\"items\":[],\"raw_summary\":\"Could not identify order items.\"}";

  var uc = [];
  if (imageData) uc.push({ type: "image", source: { type: "base64", media_type: imageData.mediaType, data: imageData.base64 } });
  uc.push({ type: "text", text: text ? "Extract and categorize all order items:\n\n" + text : "Extract and categorize all order items from this image." });

  fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
    body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 2000, system: sys, messages: [{ role: "user", content: uc }] })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) throw new Error(data.error.message);
    var rt = "";
    if (data.content) for (var i = 0; i < data.content.length; i++) { if (data.content[i].type === "text") rt += data.content[i].text; }
    rt = rt.trim(); if (!rt) throw new Error("No response");
    var parsed = JSON.parse(rt.replace(/```json/g,"").replace(/```/g,"").trim());

    var newOrder = {
      id: Date.now(), timestamp: new Date().toLocaleString(),
      customer: document.getElementById("customer-name").value.trim(),
      source: imageData ? S("photo") + ": " + imageName : S("textInput"),
      summary: parsed.raw_summary, items: parsed.items || []
    };
    orders.unshift(newOrder); sv("orders", orders);
    document.getElementById("order-count").textContent = orders.length;
    document.getElementById("input-text").value = "";
    document.getElementById("customer-name").value = "";
    removeImage(); expandedOrder = newOrder.id;
    switchTab("orders"); showToast(S("orderProcessed")); resetBtn();
  })
  .catch(function(err) { showError(err.message); resetBtn(); });
}

function resetBtn() {
  document.getElementById("lbl-process").textContent = S("process");
  var btn = document.getElementById("process-btn");
  btn.style.background = ""; btn.style.color = ""; updateProcessBtn();
}

function showError(m) { var b = document.getElementById("error-box"); b.textContent = m; b.classList.remove("hidden"); }

function renderOrders() {
  document.getElementById("order-count").textContent = orders.length;
  var c = document.getElementById("orders-list");
  var q = (document.getElementById("search-input").value || "").toLowerCase();
  var filtered = orders;
  if (q) {
    filtered = [];
    for (var i = 0; i < orders.length; i++) {
      var o = orders[i], s = (o.customer + " " + o.summary + " " + o.timestamp + " " + o.source).toLowerCase();
      for (var j = 0; j < o.items.length; j++) s += " " + o.items[j].name.toLowerCase();
      if (s.indexOf(q) >= 0) filtered.push(o);
    }
  }
  if (filtered.length === 0) {
    c.innerHTML = "<div class='empty-state'><div class='big-icon'>&#x1F4ED;</div><p>" + S("noOrders") + "</p>" +
      "<button onclick=\"switchTab('input')\" class='btn-secondary' style='margin-top:14px;'>" + S("firstOrder") + "</button></div>";
    return;
  }
  var h = "";
  for (var i = 0; i < filtered.length; i++) {
    var o = filtered[i], isExp = expandedOrder === o.id, gr = getGrouped(o.items);
    h += "<div class='order-card " + (isExp ? "expanded" : "") + "'>";
    h += "<div class='order-header' onclick='toggleOrder(" + o.id + ")'><div>";
    h += "<div class='order-title'>" + escHtml(o.source) + " \u2014 " + o.items.length + " " + S("items") + "</div>";
    if (o.customer) h += "<div class='order-customer'>" + escHtml(o.customer) + "</div>";
    h += "<div class='order-meta'>" + escHtml(o.timestamp) + "</div>";
    h += "</div><span style='font-size:14px;color:var(--text3)'>" + (isExp ? "&#x25B2;" : "&#x25BC;") + "</span></div>";
    if (isExp) h += renderBody(o, gr);
    h += "</div>";
  }
  c.innerHTML = h;
}

function renderBody(o, gr) {
  var h = "<div class='order-body'><div class='cat-badges'>";
  for (var i = 0; i < gr.length; i++) h += "<span class='cat-badge' style='background:" + gr[i].color + "22;color:" + gr[i].color + "'>" + gr[i].icon + " " + gr[i].items.length + "</span>";
  h += "</div>";
  for (var i = 0; i < gr.length; i++) {
    var g = gr[i];
    h += "<div class='cat-section'><div class='cat-label' style='color:" + g.color + "'>" + g.icon + " " + catLabel(g) + "</div><div class='items-list'>";
    for (var j = 0; j < g.items.length; j++) {
      var it = g.items[j];
      h += "<div class='item-row'><span class='item-name'>" + escHtml(it.name) + "</span><div style='display:flex;align-items:center;gap:8px'>";
      if (it.notes) h += "<span class='item-note'>" + escHtml(it.notes) + "</span>";
      h += "<span class='item-qty' style='color:" + g.color + "'>" + it.quantity + " " + escHtml(it.unit || "") + "</span></div></div>";
    }
    h += "</div></div>";
  }
  h += "<div style='text-align:right;font-size:13px;color:var(--text3);margin-bottom:8px;'>" + S("total") + ": <strong style=\"color:var(--text)\">" + o.items.length + "</strong></div>";
  h += "<div class='order-actions'>";
  h += "<button class='btn-secondary' onclick='copyOrder(" + o.id + ")'>" + S("copy") + "</button>";
  h += "<button class='btn-whatsapp' onclick='whatsappOrder(" + o.id + ")'>" + S("whatsapp") + "</button>";
  h += "<button class='btn-secondary' onclick='exportCSV(" + o.id + ")'>" + S("excel") + "</button>";
  h += "</div><div class='order-actions' style='margin-top:0;'>";
  h += "<button class='btn-secondary' style='background:#2B579A;color:#fff;border-color:#2B579A;' onclick='exportWord(" + o.id + ")'>" + S("word") + "</button>";
  h += "<button class='btn-secondary' style='background:#D32F2F;color:#fff;border-color:#D32F2F;' onclick='exportPDF(" + o.id + ")'>" + S("pdf") + "</button>";
  h += "<button class='btn-danger' onclick='deleteOrder(" + o.id + ")'>" + S("delete") + "</button>";
  h += "</div></div>";
  return h;
}

function getGrouped(items) {
  var m = {}; for (var i = 0; i < categories.length; i++) m[categories[i].key] = [];
  if (!m["other"]) m["other"] = [];
  for (var i = 0; i < items.length; i++) { var c = m[items[i].category] ? items[i].category : "other"; m[c].push(items[i]); }
  var r = [];
  for (var i = 0; i < categories.length; i++) { if (m[categories[i].key] && m[categories[i].key].length > 0) r.push({ key: categories[i].key, label: categories[i].label, labelEn: categories[i].labelEn, icon: categories[i].icon, color: categories[i].color, items: m[categories[i].key] }); }
  return r;
}

function toggleOrder(id) { expandedOrder = expandedOrder === id ? null : id; renderOrders(); }

function deleteOrder(id) {
  var n = []; for (var i = 0; i < orders.length; i++) if (orders[i].id !== id) n.push(orders[i]);
  orders = n; sv("orders", orders); renderOrders(); showToast(S("orderDeleted"));
}

function buildText(o) {
  var gr = getGrouped(o.items), t = "";
  if (o.customer) t += "*" + o.customer + "*\n";
  t += o.timestamp + "\n---\n\n";
  for (var i = 0; i < gr.length; i++) {
    var g = gr[i]; t += g.icon + " *" + catLabel(g).toUpperCase() + "*\n";
    for (var j = 0; j < g.items.length; j++) {
      var it = g.items[j]; t += "  " + it.quantity + " " + (it.unit || "") + " - " + it.name;
      if (it.notes) t += " (" + it.notes + ")"; t += "\n";
    } t += "\n";
  }
  t += "---\n" + S("total") + ": " + o.items.length;
  return t;
}

function copyOrder(id) { var o = findO(id); if (o) clip(buildText(o), S("copied")); }

function whatsappOrder(id) {
  var o = findO(id); if (!o) return;
  window.open("https://wa.me/?text=" + encodeURIComponent(buildText(o)), "_blank");
}

function exportCSV(id) {
  var o = findO(id); if (!o) return;
  var csv = "Kategorija,Artikl,Kolicina,Jedinica,Napomena\n";
  for (var i = 0; i < o.items.length; i++) {
    var it = o.items[i];
    csv += '"' + findCL(it.category) + '","' + it.name + '",' + it.quantity + ',"' + (it.unit||"") + '","' + (it.notes||"") + '"\n';
  }
  dl(csv, "narudzba_" + (o.customer || o.id) + ".csv", "text/csv");
}

function exportAllCSV() {
  if (!orders.length) return;
  var csv = "Datum,Kupac,Kategorija,Artikl,Kolicina,Jedinica,Napomena\n";
  for (var i = 0; i < orders.length; i++) {
    var o = orders[i];
    for (var j = 0; j < o.items.length; j++) {
      var it = o.items[j];
      csv += '"' + o.timestamp + '","' + (o.customer||"") + '","' + findCL(it.category) + '","' + it.name + '",' + it.quantity + ',"' + (it.unit||"") + '","' + (it.notes||"") + '"\n';
    }
  }
  dl(csv, "sve_narudzbe.csv", "text/csv");
}

function dl(content, fn, mime) {
  var blob = new Blob(["\uFEFF" + content], { type: mime + ";charset=utf-8" });
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a"); a.href = url; a.download = fn;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url); showToast(S("copied"));
}

function findO(id) { for (var i = 0; i < orders.length; i++) if (orders[i].id === id) return orders[i]; return null; }
function findCL(k) { for (var i = 0; i < categories.length; i++) if (categories[i].key === k) return catLabel(categories[i]); return k; }

function clip(text, msg) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(function() { showToast(msg); });
  } else {
    var ta = document.createElement("textarea"); ta.value = text; ta.style.position = "fixed"; ta.style.left = "-9999px";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand("copy"); showToast(msg); } catch(e) {}
    document.body.removeChild(ta);
  }
}

function showToast(m) {
  var t = document.getElementById("toast"); t.textContent = m; t.classList.add("show");
  setTimeout(function() { t.classList.remove("show"); }, 2200);
}

function escHtml(s) { if (!s) return ""; var d = document.createElement("div"); d.appendChild(document.createTextNode(s)); return d.innerHTML; }
function escAttr(s) { if (!s) return ""; return s.replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

// ========== WORD EXPORT ==========
function exportWord(id) {
  var o = findO(id); if (!o) return;
  var gr = getGrouped(o.items);

  try {
    // Check if library loaded
    if (typeof docx === "undefined") {
      showError("Word library not loaded. Check internet connection.");
      return;
    }
    var D = docx;

    var children = [];

    children.push(new D.Paragraph({
      children: [new D.TextRun({ text: lang === "hr" ? "NARUDZBA" : "ORDER", bold: true, size: 36, font: "Calibri", color: "F59E0B" })],
      spacing: { after: 100 }
    }));

    if (o.customer) {
      children.push(new D.Paragraph({
        children: [
          new D.TextRun({ text: S("customer") + ": ", bold: true, size: 24, font: "Calibri" }),
          new D.TextRun({ text: o.customer, size: 24, font: "Calibri" })
        ],
        spacing: { after: 60 }
      }));
    }

    children.push(new D.Paragraph({
      children: [new D.TextRun({ text: o.timestamp, size: 20, font: "Calibri", color: "666666" })],
      spacing: { after: 200 }
    }));

    for (var i = 0; i < gr.length; i++) {
      var g = gr[i];
      children.push(new D.Paragraph({
        children: [new D.TextRun({ text: g.icon + " " + catLabel(g).toUpperCase(), bold: true, size: 24, font: "Calibri", color: g.color.replace("#","") })],
        spacing: { before: 200, after: 100 }
      }));

      var rows = [];
      rows.push(new D.TableRow({
        children: [
          new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: lang === "hr" ? "Artikl" : "Item", bold: true, size: 20, font: "Calibri" })] })], width: { size: 50, type: D.WidthType.PERCENTAGE }, shading: { fill: "F3F4F6" } }),
          new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: lang === "hr" ? "Kolicina" : "Qty", bold: true, size: 20, font: "Calibri" })] })], width: { size: 20, type: D.WidthType.PERCENTAGE }, shading: { fill: "F3F4F6" } }),
          new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: lang === "hr" ? "Jedinica" : "Unit", bold: true, size: 20, font: "Calibri" })] })], width: { size: 15, type: D.WidthType.PERCENTAGE }, shading: { fill: "F3F4F6" } }),
          new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: lang === "hr" ? "Napomena" : "Notes", bold: true, size: 20, font: "Calibri" })] })], width: { size: 15, type: D.WidthType.PERCENTAGE }, shading: { fill: "F3F4F6" } })
        ]
      }));

      for (var j = 0; j < g.items.length; j++) {
        var it = g.items[j];
        rows.push(new D.TableRow({
          children: [
            new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: it.name || "", size: 20, font: "Calibri" })] })] }),
            new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: String(it.quantity || 0), bold: true, size: 20, font: "Calibri", color: g.color.replace("#","") })] })] }),
            new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: it.unit || "", size: 20, font: "Calibri" })] })] }),
            new D.TableCell({ children: [new D.Paragraph({ children: [new D.TextRun({ text: it.notes || "", size: 18, font: "Calibri", color: "888888" })] })] })
          ]
        }));
      }

      children.push(new D.Table({ rows: rows, width: { size: 100, type: D.WidthType.PERCENTAGE } }));
    }

    children.push(new D.Paragraph({
      children: [
        new D.TextRun({ text: S("total") + ": ", size: 22, font: "Calibri" }),
        new D.TextRun({ text: String(o.items.length), bold: true, size: 24, font: "Calibri", color: "F59E0B" })
      ],
      spacing: { before: 200 },
      alignment: D.AlignmentType.RIGHT
    }));

    var wordDoc = new D.Document({ sections: [{ children: children }] });

    D.Packer.toBlob(wordDoc).then(function(blob) {
      saveBlobFile(blob, "narudzba_" + (o.customer || o.id) + ".docx");
    }).catch(function(err) {
      showError("Word export error: " + err.message);
    });

  } catch(err) {
    showError("Word export error: " + err.message);
  }
}

// ========== PDF EXPORT ==========
function exportPDF(id) {
  var o = findO(id); if (!o) return;
  var gr = getGrouped(o.items);

  try {
    if (typeof window.jspdf === "undefined") {
      showError("PDF library not loaded. Check internet connection.");
      return;
    }
    var jsPDF = window.jspdf.jsPDF;
    var pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

    var pageW = pdf.internal.pageSize.getWidth();
    var margin = 15;
    var y = 20;

    pdf.setFontSize(22);
    pdf.setTextColor(245, 158, 11);
    pdf.setFont("helvetica", "bold");
    pdf.text(lang === "hr" ? "NARUDZBA" : "ORDER", margin, y);
    y += 10;

    if (o.customer) {
      pdf.setFontSize(14);
      pdf.setTextColor(50, 50, 50);
      pdf.setFont("helvetica", "bold");
      pdf.text(S("customer") + ": ", margin, y);
      pdf.setFont("helvetica", "normal");
      pdf.text(o.customer, margin + pdf.getTextWidth(S("customer") + ": "), y);
      y += 7;
    }

    pdf.setFontSize(10);
    pdf.setTextColor(120, 120, 120);
    pdf.setFont("helvetica", "normal");
    pdf.text(o.timestamp, margin, y);
    y += 5;

    pdf.setDrawColor(200, 200, 200);
    pdf.line(margin, y, pageW - margin, y);
    y += 8;

    for (var i = 0; i < gr.length; i++) {
      var g = gr[i];
      if (y > 260) { pdf.addPage(); y = 20; }

      var col = hexToRgb(g.color);
      pdf.setFontSize(13);
      pdf.setTextColor(col.r, col.g, col.b);
      pdf.setFont("helvetica", "bold");
      pdf.text(catLabel(g).toUpperCase(), margin, y);
      y += 3;

      var tableData = [];
      for (var j = 0; j < g.items.length; j++) {
        var it = g.items[j];
        tableData.push([it.name || "", String(it.quantity || 0), it.unit || "", it.notes || ""]);
      }

      pdf.autoTable({
        startY: y,
        margin: { left: margin, right: margin },
        head: [[
          lang === "hr" ? "Artikl" : "Item",
          lang === "hr" ? "Kol." : "Qty",
          lang === "hr" ? "Jed." : "Unit",
          lang === "hr" ? "Napomena" : "Notes"
        ]],
        body: tableData,
        theme: "grid",
        styles: { fontSize: 10, cellPadding: 3, font: "helvetica" },
        headStyles: { fillColor: [col.r, col.g, col.b], textColor: [255, 255, 255], fontStyle: "bold" },
        columnStyles: {
          0: { cellWidth: "auto" },
          1: { cellWidth: 20, halign: "center", fontStyle: "bold" },
          2: { cellWidth: 25 },
          3: { cellWidth: 35, fontSize: 8, textColor: [150, 150, 150] }
        }
      });

      y = pdf.lastAutoTable.finalY + 8;
    }

    if (y > 270) { pdf.addPage(); y = 20; }
    pdf.setDrawColor(200, 200, 200);
    pdf.line(margin, y, pageW - margin, y);
    y += 6;
    pdf.setFontSize(12);
    pdf.setTextColor(50, 50, 50);
    pdf.setFont("helvetica", "normal");
    var totalText = S("total") + ": " + o.items.length;
    pdf.text(totalText, pageW - margin - pdf.getTextWidth(totalText), y);

    pdf.save("narudzba_" + (o.customer || o.id) + ".pdf");
    showToast(S("copied"));

  } catch(err) {
    showError("PDF export error: " + err.message);
  }
}

function hexToRgb(hex) {
  hex = hex.replace("#", "");
  return { r: parseInt(hex.substring(0,2),16), g: parseInt(hex.substring(2,4),16), b: parseInt(hex.substring(4,6),16) };
}

// Save blob for iOS Safari compatibility
function saveBlobFile(blob, filename) {
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  setTimeout(function() {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 1000);
  showToast(S("copied"));
}

document.getElementById("order-count").textContent = orders.length;
updateSettingsIcon();
setLang(lang);
</script>
</body>
</html>
