<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0F1117">
<title>Order Processor</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiT3JkZXIgUHJvY2Vzc29yIiwic2hvcnRfbmFtZSI6Ik9yZGVycyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMEYxMTE3IiwidGhlbWVfY29sb3IiOiIjMEYxMTE3In0=">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --bg: #0F1117;
    --bg2: #1A1D27;
    --bg3: #2A2D3A;
    --text: #E2E4E9;
    --text2: #9CA3AF;
    --text3: #6B7280;
    --accent: #F59E0B;
    --red: #EF4444;
    --green: #10B981;
    --blue: #3B82F6;
    --cyan: #06B6D4;
    --purple: #8B5CF6;
    --orange: #F97316;
  }

  body {
    font-family: 'DM Sans', 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--bg2) 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--bg3);
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-inner {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo {
    width: 40px; height: 40px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--red));
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .header h1 {
    font-size: 18px; font-weight: 700;
    font-family: 'Space Mono', monospace;
    background: linear-gradient(90deg, var(--accent), var(--red));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header p { font-size: 11px; color: var(--text3); }

  /* Tabs */
  .tabs {
    max-width: 600px; margin: 12px auto 0; padding: 0 16px;
  }
  .tabs-inner {
    display: flex; gap: 4px; background: var(--bg2);
    border-radius: 10px; padding: 4px;
  }
  .tab-btn {
    flex: 1; padding: 10px 12px; border: none; border-radius: 8px;
    cursor: pointer; font-size: 14px; font-weight: 600;
    font-family: inherit; transition: all 0.2s;
    background: transparent; color: var(--text3);
  }
  .tab-btn.active {
    background: var(--bg3); color: var(--accent);
  }

  /* Content */
  .content {
    max-width: 600px; margin: 0 auto;
    padding: 16px 16px 100px;
  }

  /* Input Section */
  .section-label {
    font-size: 13px; font-weight: 600; color: var(--text2);
    margin-bottom: 6px; display: block;
  }
  textarea {
    width: 100%; min-height: 180px; padding: 14px;
    border: 1px solid var(--bg3); border-radius: 12px;
    background: var(--bg2); color: var(--text); font-size: 14px;
    font-family: inherit; resize: vertical; outline: none;
    line-height: 1.6; transition: border-color 0.2s;
  }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--text3); }

  .upload-zone {
    border: 2px dashed var(--bg3); border-radius: 12px;
    padding: 22px 14px; text-align: center; cursor: pointer;
    background: var(--bg2); transition: all 0.2s;
    margin-top: 14px;
  }
  .upload-zone:active { border-color: var(--accent); background: #1E2130; }
  .upload-zone .icon { font-size: 28px; margin-bottom: 4px; }
  .upload-zone .hint { color: var(--text3); font-size: 13px; }

  .file-attached {
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .file-attached .check { color: var(--green); font-size: 18px; }
  .file-attached .name { color: var(--text); font-size: 14px; }
  .remove-btn {
    background: var(--red); border: none; color: #fff;
    border-radius: 6px; padding: 2px 8px; cursor: pointer; font-size: 12px;
  }

  .process-btn {
    width: 100%; padding: 14px 24px; border: none; border-radius: 10px;
    cursor: pointer; font-size: 16px; font-weight: 700;
    font-family: 'Space Mono', monospace;
    background: linear-gradient(135deg, var(--accent), var(--red));
    color: var(--bg); margin-top: 16px; transition: all 0.2s;
  }
  .process-btn:disabled {
    background: var(--bg3); color: var(--text3); opacity: 0.5;
  }
  .process-btn.loading {
    background: var(--bg3); color: var(--text3);
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:0.6} 50%{opacity:1} }

  .tips {
    padding: 14px; background: var(--bg2); border-radius: 12px;
    border: 1px solid var(--bg3); font-size: 13px;
    color: var(--text3); line-height: 1.7; margin-top: 14px;
  }
  .tips strong { color: var(--text2); }

  .error-msg {
    padding: 12px 14px; background: #2D1215;
    border: 1px solid var(--red); border-radius: 10px;
    color: #FCA5A5; font-size: 13px; margin-top: 14px;
  }

  /* Orders */
  .empty-state {
    text-align: center; padding: 50px 20px; color: var(--text3);
  }
  .empty-state .big-icon { font-size: 48px; margin-bottom: 10px; }
  .empty-state p { font-size: 15px; }
  .go-input-btn {
    margin-top: 12px; padding: 10px 20px; background: var(--bg3);
    border: none; border-radius: 8px; color: var(--accent);
    cursor: pointer; font-weight: 600; font-family: inherit;
  }

  .order-card {
    background: var(--bg2); border-radius: 14px;
    border: 1px solid var(--bg3); overflow: hidden;
    margin-bottom: 12px; transition: border-color 0.2s;
  }
  .order-card.expanded { border-color: rgba(245,158,11,0.2); }

  .order-header {
    padding: 14px 16px; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
  }
  .order-title { font-size: 14px; font-weight: 600; color: var(--text); }
  .order-meta { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .chevron { font-size: 12px; color: var(--text3); }

  .order-body { padding: 0 16px 16px; }

  .cat-badges {
    display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap;
  }
  .cat-badge {
    padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
  }

  .cat-section { margin-bottom: 16px; }
  .cat-label {
    font-size: 13px; font-weight: 700;
    margin-bottom: 8px; font-family: 'Space Mono', monospace;
    text-transform: uppercase; letter-spacing: 1px;
  }
  .items-list {
    background: var(--bg); border-radius: 10px;
    border: 1px solid var(--bg3); overflow: hidden;
  }
  .item-row {
    padding: 10px 14px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--bg2);
  }
  .item-row:last-child { border-bottom: none; }
  .item-name { font-size: 14px; color: var(--text); flex: 1; }
  .item-qty {
    font-weight: 700; font-size: 14px;
    font-family: 'Space Mono', monospace; white-space: nowrap;
  }
  .item-note {
    font-size: 11px; color: var(--text2); background: var(--bg3);
    padding: 2px 6px; border-radius: 4px; margin-right: 8px;
  }

  .order-actions {
    display: flex; gap: 8px; margin-top: 10px;
  }
  .action-btn {
    flex: 1; padding: 10px 14px; border: 1px solid var(--bg3);
    border-radius: 8px; background: var(--bg); color: var(--text2);
    cursor: pointer; font-size: 13px; font-weight: 600;
    font-family: inherit; transition: all 0.2s;
  }
  .action-btn:active { background: var(--bg3); }
  .action-btn.delete { color: var(--red); flex: 0; }

  .toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--green); color: #fff; padding: 10px 20px;
    border-radius: 10px; font-size: 14px; font-weight: 600;
    z-index: 999; animation: fadeInOut 2s forwards;
  }
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
    15% { opacity: 1; transform: translateX(-50%) translateY(0); }
    80% { opacity: 1; }
    100% { opacity: 0; }
  }

  .hidden { display: none; }

  .settings-toggle {
    background: none; border: 1px solid var(--bg3); border-radius: 8px;
    color: var(--text2); font-size: 18px; cursor: pointer;
    width: 38px; height: 38px; display: flex; align-items: center;
    justify-content: center; transition: all 0.2s; flex-shrink: 0;
  }
  .settings-toggle:active { background: var(--bg3); }
  .settings-toggle.has-key { border-color: var(--green); color: var(--green); }

  .settings-panel {
    background: var(--bg2); border-bottom: 1px solid var(--bg3);
    overflow: hidden; transition: all 0.3s;
  }
  .settings-inner {
    max-width: 600px; margin: 0 auto; padding: 16px 20px;
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-inner">
    <div class="logo">üìã</div>
    <div style="flex:1">
      <h1>Order Processor</h1>
      <p>Paste or photograph any order ‚Üí structured &amp; categorized</p>
    </div>
    <button class="settings-toggle" id="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</button>
  </div>
</div>

<!-- Settings Panel -->
<div class="settings-panel hidden" id="settings-panel">
  <div class="settings-inner">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 style="font-size:16px;font-weight:700;font-family:'Space Mono',monospace;color:var(--accent);">‚öôÔ∏è Settings</h2>
      <button onclick="toggleSettings()" style="background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;">‚úï</button>
    </div>
    <label class="section-label">Anthropic API Key</label>
    <div style="display:flex;gap:8px;">
      <input type="password" id="api-key-input" placeholder="sk-ant-api03-..." 
        style="flex:1;padding:10px 14px;border:1px solid var(--bg3);border-radius:8px;background:var(--bg);color:var(--text);font-size:14px;font-family:inherit;outline:none;"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--bg3)'" />
      <button onclick="toggleKeyVisibility()" id="eye-btn" style="padding:10px 12px;border:1px solid var(--bg3);border-radius:8px;background:var(--bg);color:var(--text2);cursor:pointer;font-size:16px;border:1px solid var(--bg3);">üëÅÔ∏è</button>
    </div>
    <button onclick="saveApiKey()" style="width:100%;margin-top:10px;padding:10px;border:none;border-radius:8px;background:var(--accent);color:var(--bg);font-weight:700;font-family:inherit;cursor:pointer;font-size:14px;">üíæ Save Key</button>
    <div id="key-status" style="margin-top:8px;font-size:12px;color:var(--text3);"></div>
    <div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--bg3);">
      <p style="font-size:12px;color:var(--text3);line-height:1.6;">
        üîí Your API key is stored locally on your device only. Get your key from 
        <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent);text-decoration:none;">console.anthropic.com</a>
      </p>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabs-inner">
    <button class="tab-btn active" id="tab-input" onclick="switchTab('input')">‚úèÔ∏è New Order</button>
    <button class="tab-btn" id="tab-orders" onclick="switchTab('orders')">üìÇ Orders (<span id="order-count">0</span>)</button>
  </div>
</div>

<!-- Content -->
<div class="content">

  <!-- INPUT VIEW -->
  <div id="view-input">
    <label class="section-label" style="margin-top:8px;">Paste order text (email, WhatsApp, SMS, etc.)</label>
    <textarea id="input-text" placeholder="e.g.
Hi, please send us:
20 boxes Heineken
10 bottles Coca Cola 1.5L
5 crates mineral water
3 boxes dish soap
..."></textarea>

    <label class="section-label" style="margin-top:14px;">Or upload a photo / screenshot</label>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div id="upload-content">
        <div class="icon">üì∏</div>
        <div class="hint">Tap to upload photo, screenshot, or handwritten note</div>
      </div>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(event)">

    <div id="error-box" class="error-msg hidden"></div>

    <button class="process-btn" id="process-btn" onclick="processOrder()" disabled>
      ‚ö° Process Order
    </button>

    <div class="tips">
      <strong>üí° Tips:</strong> Paste any format ‚Äî messy emails, WhatsApp forwards, SMS, or upload photos of handwritten orders. The AI will extract items and sort them into categories automatically.
    </div>
  </div>

  <!-- ORDERS VIEW -->
  <div id="view-orders" class="hidden">
    <div id="orders-list"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<script>
const CATEGORIES = [
  { key: "beers", label: "Beers", icon: "üç∫", color: "#F59E0B" },
  { key: "alcohol", label: "Alcohol Drinks", icon: "ü•É", color: "#EF4444" },
  { key: "soft_drinks", label: "Soft Drinks", icon: "ü•§", color: "#3B82F6" },
  { key: "water", label: "Water", icon: "üíß", color: "#06B6D4" },
  { key: "other_beverages", label: "Other Beverages", icon: "üßÉ", color: "#8B5CF6" },
  { key: "food", label: "Food", icon: "üçΩÔ∏è", color: "#10B981" },
  { key: "chemicals", label: "Chemicals", icon: "üß¥", color: "#F97316" },
  { key: "other", label: "Other", icon: "üì¶", color: "#6B7280" },
];

const SYSTEM_PROMPT = `You are an order processing assistant. Your job is to extract order items from messy, unstructured text that may come from emails, WhatsApp messages, Viber, SMS, handwritten notes (OCR'd), or photos.

Extract each item with:
- name: the product name (clean it up, fix typos if obvious)
- quantity: number ordered (default to 1 if not specified)
- unit: unit of measurement (e.g., "boxes", "bottles", "crates", "pcs", "kg", "liters", etc.) - infer from context if not explicit
- category: one of exactly these: "beers", "alcohol", "soft_drinks", "water", "other_beverages", "food", "chemicals", "other"
- notes: any special instructions or details

Category guidelines:
- beers: all beer brands and types (lager, ale, craft, etc.)
- alcohol: wine, spirits, liquor, cocktails, etc.
- soft_drinks: cola, juice, energy drinks, sodas, etc.
- water: still water, sparkling water, mineral water
- other_beverages: coffee, tea, milk, and other drinks not in above categories
- food: all food items, snacks, ingredients
- chemicals: cleaning products, detergents, sanitizers, etc.
- other: anything that doesn't fit above

Respond ONLY with a JSON object (no markdown, no backticks) in this exact format:
{
  "items": [
    { "name": "Product Name", "quantity": 10, "unit": "boxes", "category": "beers", "notes": "" }
  ],
  "raw_summary": "Brief one-line summary of the order"
}

If the text is not an order or you can't extract items, return:
{ "items": [], "raw_summary": "Could not identify order items in the provided text." }`;

let orders = JSON.parse(localStorage.getItem('orders') || '[]');
let imageData = null;
let imageName = "";
let expandedOrder = null;

function saveOrders() {
  try { localStorage.setItem('orders', JSON.stringify(orders)); } catch(e) {}
}

// API Key management
function getApiKey() {
  return localStorage.getItem('anthropic_api_key') || '';
}

function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) {
    localStorage.removeItem('anthropic_api_key');
    document.getElementById('key-status').innerHTML = '<span style="color:var(--red)">Key removed.</span>';
    updateSettingsIcon();
    return;
  }
  localStorage.setItem('anthropic_api_key', key);
  document.getElementById('key-status').innerHTML = '<span style="color:var(--green)">‚úì Key saved securely on your device.</span>';
  updateSettingsIcon();
}

function updateSettingsIcon() {
  const btn = document.getElementById('settings-toggle');
  if (getApiKey()) {
    btn.classList.add('has-key');
  } else {
    btn.classList.remove('has-key');
  }
}

function toggleSettings() {
  const panel = document.getElementById('settings-panel');
  panel.classList.toggle('hidden');
  if (!panel.classList.contains('hidden')) {
    const key = getApiKey();
    document.getElementById('api-key-input').value = key;
    document.getElementById('key-status').textContent = key ? '‚úì Key is set' : 'No key saved yet.';
  }
}

function toggleKeyVisibility() {
  const input = document.getElementById('api-key-input');
  input.type = input.type === 'password' ? 'text' : 'password';
}

// Tab switching
function switchTab(tab) {
  document.getElementById('tab-input').classList.toggle('active', tab === 'input');
  document.getElementById('tab-orders').classList.toggle('active', tab === 'orders');
  document.getElementById('view-input').classList.toggle('hidden', tab !== 'input');
  document.getElementById('view-orders').classList.toggle('hidden', tab !== 'orders');
  if (tab === 'orders') renderOrders();
}

// File handling
function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  imageName = file.name;
  const reader = new FileReader();
  reader.onload = () => {
    const base64 = reader.result.split(',')[1];
    imageData = { base64, mediaType: file.type || 'image/jpeg' };
    document.getElementById('upload-content').innerHTML = `
      <div class="file-attached">
        <span class="check">‚úì</span>
        <span class="name">${imageName}</span>
        <button class="remove-btn" onclick="event.stopPropagation(); removeImage()">‚úï</button>
      </div>`;
    updateProcessBtn();
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  imageData = null; imageName = "";
  document.getElementById('file-input').value = "";
  document.getElementById('upload-content').innerHTML = `
    <div class="icon">üì∏</div>
    <div class="hint">Tap to upload photo, screenshot, or handwritten note</div>`;
  updateProcessBtn();
}

function updateProcessBtn() {
  const text = document.getElementById('input-text').value.trim();
  document.getElementById('process-btn').disabled = (!text && !imageData);
}
document.getElementById('input-text').addEventListener('input', updateProcessBtn);

// Process order
async function processOrder() {
  const text = document.getElementById('input-text').value.trim();
  if (!text && !imageData) return;

  const btn = document.getElementById('process-btn');
  btn.classList.add('loading');
  btn.disabled = true;
  btn.textContent = '‚è≥ Processing with AI...';
  document.getElementById('error-box').classList.add('hidden');

  try {
    const apiKey = getApiKey();
    if (!apiKey) {
      throw new Error("Please add your Anthropic API key in ‚öôÔ∏è Settings first.");
    }

    const userContent = [];
    if (imageData) {
      userContent.push({
        type: "image",
        source: { type: "base64", media_type: imageData.mediaType, data: imageData.base64 }
      });
    }
    const textPart = text
      ? `Extract and categorize all order items from the following:\n\n${text}`
      : "Extract and categorize all order items from this image.";
    userContent.push({ type: "text", text: textPart });

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: SYSTEM_PROMPT,
        messages: [{ role: "user", content: userContent }],
      }),
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message || "API error");

    const respText = data.content?.map(b => b.type === 'text' ? b.text : '').join('').trim();
    if (!respText) throw new Error("No response from AI");

    const cleaned = respText.replace(/```json|```/g, '').trim();
    const parsed = JSON.parse(cleaned);

    const newOrder = {
      id: Date.now(),
      timestamp: new Date().toLocaleString(),
      source: imageData ? `üì∑ ${imageName}` : "üìù Text input",
      summary: parsed.raw_summary,
      items: parsed.items || [],
      inputPreview: text.substring(0, 120) || "(image)",
    };

    orders.unshift(newOrder);
    saveOrders();
    document.getElementById('order-count').textContent = orders.length;

    // Reset input
    document.getElementById('input-text').value = "";
    removeImage();
    expandedOrder = newOrder.id;
    switchTab('orders');
    showToast('‚úì Order processed!');

  } catch (err) {
    const errBox = document.getElementById('error-box');
    errBox.textContent = "Failed to process order. " + err.message;
    errBox.classList.remove('hidden');
  } finally {
    btn.classList.remove('loading');
    btn.textContent = '‚ö° Process Order';
    updateProcessBtn();
  }
}

// Render orders
function renderOrders() {
  document.getElementById('order-count').textContent = orders.length;
  const container = document.getElementById('orders-list');

  if (orders.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="big-icon">üì≠</div>
        <p>No orders processed yet.</p>
        <button class="go-input-btn" onclick="switchTab('input')">‚úèÔ∏è Process your first order</button>
      </div>`;
    return;
  }

  container.innerHTML = orders.map(order => {
    const isExpanded = expandedOrder === order.id;
    const grouped = getGrouped(order.items);
    return `
      <div class="order-card ${isExpanded ? 'expanded' : ''}">
        <div class="order-header" onclick="toggleOrder(${order.id})">
          <div>
            <div class="order-title">${order.source} ‚Äî ${order.items.length} items</div>
            <div class="order-meta">${order.timestamp} ¬∑ ${escHtml(order.summary)}</div>
          </div>
          <span class="chevron">${isExpanded ? '‚ñ≤' : '‚ñº'}</span>
        </div>
        ${isExpanded ? renderOrderBody(order, grouped) : ''}
      </div>`;
  }).join('');
}

function renderOrderBody(order, grouped) {
  const badges = grouped.map(g =>
    `<span class="cat-badge" style="background:${g.color}22;color:${g.color}">${g.icon} ${g.items.length}</span>`
  ).join('');

  const sections = grouped.map(g => `
    <div class="cat-section">
      <div class="cat-label" style="color:${g.color}">${g.icon} ${g.label}</div>
      <div class="items-list">
        ${g.items.map(item => `
          <div class="item-row">
            <span class="item-name">${escHtml(item.name)}</span>
            <div style="display:flex;align-items:center;gap:8px">
              ${item.notes ? `<span class="item-note">${escHtml(item.notes)}</span>` : ''}
              <span class="item-qty" style="color:${g.color}">${item.quantity} ${escHtml(item.unit || '')}</span>
            </div>
          </div>`).join('')}
      </div>
    </div>`).join('');

  return `
    <div class="order-body">
      <div class="cat-badges">${badges}</div>
      ${sections}
      <div class="order-actions">
        <button class="action-btn" onclick="exportOrder(${order.id})">üìã Copy to Clipboard</button>
        <button class="action-btn delete" onclick="deleteOrder(${order.id})">üóëÔ∏è</button>
      </div>
    </div>`;
}

function getGrouped(items) {
  const map = {};
  CATEGORIES.forEach(c => map[c.key] = []);
  items.forEach(item => {
    const cat = map[item.category] ? item.category : 'other';
    map[cat].push(item);
  });
  return CATEGORIES.filter(c => map[c.key].length > 0).map(c => ({ ...c, items: map[c.key] }));
}

function toggleOrder(id) {
  expandedOrder = expandedOrder === id ? null : id;
  renderOrders();
}

function deleteOrder(id) {
  orders = orders.filter(o => o.id !== id);
  saveOrders();
  renderOrders();
  showToast('Order deleted');
}

function exportOrder(id) {
  const order = orders.find(o => o.id === id);
  if (!order) return;
  const grouped = getGrouped(order.items);
  let text = `ORDER ‚Äî ${order.timestamp}\nSource: ${order.source}\n${'‚îÄ'.repeat(40)}\n\n`;
  grouped.forEach(g => {
    text += `${g.icon} ${g.label.toUpperCase()}\n`;
    g.items.forEach(item => {
      text += `  ‚Ä¢ ${item.quantity} ${item.unit || ''} ‚Äî ${item.name}`;
      if (item.notes) text += ` (${item.notes})`;
      text += '\n';
    });
    text += '\n';
  });
  text += `${'‚îÄ'.repeat(40)}\nTotal items: ${order.items.length}`;
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => showToast('üìã Copied to clipboard!'));
  } else {
    // Fallback for older mobile browsers
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('üìã Copied to clipboard!');
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  t.style.animation = 'none';
  t.offsetHeight; // reflow
  t.style.animation = 'fadeInOut 2s forwards';
  setTimeout(() => t.classList.add('hidden'), 2100);
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Init
document.getElementById('order-count').textContent = orders.length;
updateSettingsIcon();
</script>
</body>
</html>
